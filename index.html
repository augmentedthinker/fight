<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Combat Mechanic Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        /* Backdrop style */
        body { 
            background-color: #020617; 
            color: #e2e8f0; 
            font-family: 'MedievalSharp', cursive; 
            background-image: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }
        
        /* Split Screen Styles */
        .split-panel {
            position: relative;
            width: 50%;
            height: 100%;
            overflow: hidden;
            border-right: 2px solid #000;
            border-left: 2px solid #000;
        }
        .split-panel::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.9) 100%);
            pointer-events: none;
            transition: all 0.5s ease-in-out;
        }
        .split-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        /* HP Bar Styles */
        .hp-track {
            width: 100%;
            height: 32px;
            background: #1e293b;
            border: 3px solid #0f172a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 10px #000;
            margin-top: 4px;
        }
        .hp-fill {
            height: 100%;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.3);
        }

        .text-glow {
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }

        .active-turn .split-image { transform: scale(1.1); filter: brightness(1.1); }
        .inactive-turn .split-image { filter: grayscale(0.8) brightness(0.5); }
        .taking-damage { animation: damage-flash 0.3s; }
        @keyframes damage-flash { 50% { filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } }

        /* --- REALISTIC DICE STYLES --- */
        .die-btn {
            position: relative;
            width: 52px; height: 52px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.4;
            filter: grayscale(0.8);
            cursor: not-allowed;
        }
        @media (min-width: 1024px) { .die-btn { width: 64px; height: 64px; } }

        /* Active State (Clickable) */
        .die-active {
            opacity: 1;
            filter: grayscale(0) drop-shadow(0 0 8px rgba(220, 38, 38, 0.6));
            transform: scale(1.1);
            cursor: pointer;
            animation: pulse-glow 2s infinite;
        }
        .die-active:hover { transform: scale(1.2); }

        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(220, 38, 38, 0.4)); }
            50% { filter: drop-shadow(0 0 15px rgba(220, 38, 38, 0.8)); }
        }

        /* Rolling Animation */
        @keyframes roll { 0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
        .rolling { animation: roll 0.2s infinite; }

        .die-shape { 
            fill: #b91c1c; /* Deep Red */
            stroke: rgba(255,255,255,0.6); 
            stroke-width: 1.5;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
        }
        
        .die-inner {
            fill: none;
            stroke: rgba(255,255,255,0.4);
            stroke-width: 1;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .die-text { 
            font-family: sans-serif; 
            font-weight: 800; 
            font-size: 16px; 
            fill: #ffffff; 
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex items-center justify-center p-4">

    <div id="mobile-frame" class="relative w-full max-w-[420px] h-full max-h-[900px] bg-slate-950 shadow-2xl flex flex-col overflow-hidden rounded-[2rem] border-[8px] border-slate-800 ring-1 ring-white/10 lg:rounded-[3rem] lg:border-[12px]">

        <!-- TOP SECTION: BATTLE VIEW (55% Height) -->
        <div class="h-[55%] w-full flex relative bg-slate-900">
            <!-- HERO -->
            <div id="hero-panel" class="split-panel active-turn border-r-4 border-slate-900">
                <img src="https://image.pollinations.ai/prompt/fantasy%20warrior%20portrait%20rugged%20face%20scarred%20armor%20heroic%20lighting%201970s%20dnd%20art%20style%20oil%20painting?width=600&height=1024&nologin=true&seed=99" class="split-image" alt="Hero">
                <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black via-black/80 to-transparent pt-12 flex flex-col z-10">
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-bold text-blue-400 text-glow tracking-wider">HERO</span>
                        <span id="hero-hp-text" class="text-2xl font-bold text-white text-glow">20</span>
                    </div>
                    <div class="hp-track h-6 border-2"><div id="hero-bar" class="hp-fill bg-blue-600" style="width: 100%"></div></div>
                    <div class="mt-2 flex gap-1">
                        <span class="px-1.5 py-0.5 bg-slate-800 border border-slate-600 rounded text-[10px] text-slate-300 font-bold">AC 14</span>
                        <span class="px-1.5 py-0.5 bg-slate-800 border border-slate-600 rounded text-[10px] text-slate-300 font-bold">Shortsword (1d6)</span>
                    </div>
                </div>
            </div>

            <!-- VS Badge -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none">
                <span class="text-6xl font-black text-white italic text-glow drop-shadow-2xl" style="font-family: serif;">VS</span>
            </div>

            <!-- ENEMY -->
            <div id="enemy-panel" class="split-panel inactive-turn border-l-4 border-slate-900">
                <img src="https://image.pollinations.ai/prompt/fearsome%20ogre%20portrait%20fantasy%20art%201970s%20style?width=600&height=1024&nologin=true" class="split-image" alt="Enemy">
                <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black via-black/80 to-transparent pt-12 flex flex-col z-10">
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-bold text-red-500 text-glow tracking-wider">OGRE</span>
                        <span id="enemy-hp-text" class="text-2xl font-bold text-white text-glow">15</span>
                    </div>
                    <div class="hp-track h-6 border-2"><div id="enemy-bar" class="hp-fill bg-red-600" style="width: 100%"></div></div>
                    <div class="mt-2 flex gap-1 justify-end">
                        <span class="px-1.5 py-0.5 bg-slate-800 border border-slate-600 rounded text-[10px] text-slate-300 font-bold">AC 12</span>
                        <span class="px-1.5 py-0.5 bg-slate-800 border border-slate-600 rounded text-[10px] text-slate-300 font-bold">Claws (1d4)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTTOM SECTION: DICE TRAY (45% Height) -->
        <div class="h-[45%] w-full bg-slate-900 border-t-4 border-slate-700 flex flex-col items-center p-4 shadow-[0_-10px_20px_rgba(0,0,0,0.5)] z-20">
            
            <!-- Turn & Log -->
            <div class="w-full text-center mb-4">
                <div id="turn-banner" class="inline-block mb-2 bg-yellow-600 text-black px-6 py-1 rounded-full font-bold uppercase tracking-widest text-xs shadow-lg transition-colors duration-300">Your Turn</div>
                <div id="log-text" class="text-sm text-slate-300 h-6 leading-6 truncate font-sans">Roll D20 to Attack!</div>
            </div>

            <!-- DICE ROW: Realistic 3D SVG Geometry -->
            <div class="flex flex-wrap justify-center gap-2 mb-6 w-full px-2">
                
                <!-- D4 -->
                <div id="d4-btn" class="die-btn" onclick="battle.rollUserDie(4)">
                    <svg viewBox="0 0 100 100" class="overflow-visible">
                        <path d="M50 10 L90 80 H10 Z" class="die-shape" />
                        <path d="M50 10 L50 60 L10 80 M50 60 L90 80" class="die-inner" />
                        <text x="50" y="72" text-anchor="middle" class="die-text">4</text>
                    </svg>
                </div>

                <!-- D6 -->
                <div id="d6-btn" class="die-btn" onclick="battle.rollUserDie(6)">
                    <svg viewBox="0 0 100 100" class="overflow-visible">
                        <path d="M20 30 L70 30 L70 80 L20 80 Z" class="die-shape" /> <!-- Front -->
                        <path d="M20 30 L40 10 L90 10 L70 30" class="die-shape" /> <!-- Top -->
                        <path d="M70 30 L90 10 L90 60 L70 80" class="die-shape" /> <!-- Side -->
                        <text x="45" y="60" text-anchor="middle" class="die-text">6</text>
                    </svg>
                </div>

                <!-- D8 -->
                <div id="d8-btn" class="die-btn" onclick="battle.rollUserDie(8)">
                    <svg viewBox="0 0 100 100" class="overflow-visible">
                        <path d="M50 2 L95 50 L50 98 L5 50 Z" class="die-shape" />
                        <path d="M50 2 L50 98 M5 50 L95 50" class="die-inner" />
                        <text x="50" y="60" text-anchor="middle" class="die-text">8</text>
                    </svg>
                </div>

                <!-- D10 -->
                <div id="d10-btn" class="die-btn" onclick="battle.rollUserDie(10)">
                    <svg viewBox="0 0 100 100" class="overflow-visible">
                        <path d="M50 2 L90 35 L50 98 L10 35 Z" class="die-shape" />
                        <path d="M50 2 L50 98 M10 35 L50 65 L90 35" class="die-inner" />
                        <text x="50" y="52" text-anchor="middle" class="die-text" style="font-size: 14px">10</text>
                    </svg>
                </div>

                <!-- D12 -->
                <div id="d12-btn" class="die-btn" onclick="battle.rollUserDie(12)">
                    <svg viewBox="0 0 100 100" class="overflow-visible">
                        <path d="M50 5 L88 32 L73 78 L27 78 L12 32 Z" class="die-shape" />
                        <path d="M50 25 L70 38 L63 60 H37 L30 38 Z" class="die-inner" fill="rgba(0,0,0,0.2)"/>
                        <path d="M50 5 L50 25 M88 32 L70 38 M73 78 L63 60 M27 78 L37 60 M12 32 L30 38" class="die-inner" />
                        <text x="50" y="55" text-anchor="middle" class="die-text">12</text>
                    </svg>
                </div>

                <!-- D20: CORRECT ICOSAHEDRON PROJECTION -->
                <div id="d20-btn" class="die-btn die-active" onclick="battle.rollUserDie(20)">
                    <svg viewBox="0 0 100 100" class="overflow-visible">
                        <!-- Outer Shape (Hexagon) -->
                        <path d="M50 5 L92 28 L92 72 L50 95 L8 72 L8 28 Z" class="die-shape" />
                        
                        <!-- Internal Triangles (Face Up Projection) -->
                        <!-- Center Triangle (The Face with the number) -->
                        <path d="M28 35 L72 35 L50 75 Z" class="die-inner" stroke-width="1.5" />
                        
                        <!-- Connecting Lines to Corners -->
                        <path d="M50 5 L28 35" class="die-inner" />
                        <path d="M50 5 L72 35" class="die-inner" />
                        <path d="M92 28 L72 35" class="die-inner" />
                        <path d="M92 72 L72 35" class="die-inner" />
                        <path d="M92 72 L50 75" class="die-inner" />
                        <path d="M50 95 L50 75" class="die-inner" />
                        <path d="M8 72 L50 75" class="die-inner" />
                        <path d="M8 72 L28 35" class="die-inner" />
                        <path d="M8 28 L28 35" class="die-inner" />
                        <path d="M8 28 L50 5" class="die-inner" /> <!-- Closing the top left -->

                        <text x="50" y="60" text-anchor="middle" class="die-text" style="font-size: 18px;">20</text>
                    </svg>
                </div>
            </div>

            <!-- Reset Button (Bottom Corner) -->
            <div class="absolute bottom-4 right-4">
                 <button onclick="battle.reset()" class="text-slate-600 hover:text-slate-400 transition-colors"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Overlay -->
        <div id="end-overlay" class="absolute inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
            <h1 id="end-title" class="text-6xl font-black text-white mb-2 text-glow">VICTORY</h1>
            <button onclick="battle.reset()" class="mt-8 bg-white text-black px-8 py-3 rounded-full font-bold hover:scale-105 transition-transform flex items-center gap-2">Play Again</button>
        </div>
    </div>

    <script>
        // Character Stats
        const STATS = {
            hero: { hp: 20, max: 20, ac: 14, ab: 1, dmgDie: 6, dmgMod: 1 },
            enemy: { hp: 15, max: 15, ac: 12, ab: 0, dmgDie: 4, dmgMod: 0 }
        };

        const battle = {
            state: {
                heroHp: 20, enemyHp: 15, isOver: false,
                turn: 'player', // 'player', 'enemy'
                phase: 'attack', // 'attack', 'damage', 'wait'
                lastCrit: false
            },

            reset() {
                this.state = { heroHp: STATS.hero.max, enemyHp: STATS.enemy.max, isOver: false, turn: 'player', phase: 'attack', lastCrit: false };
                document.getElementById('end-overlay').classList.add('hidden');
                this.updateUI();
                this.setTurnUI('player', 'attack');
                this.log("Roll D20 to attack!", "text-white");
            },

            // Click on Dice
            rollUserDie(sides) {
                if (this.state.isOver || this.state.turn !== 'player') return;

                // Validate correct die
                if (this.state.phase === 'attack' && sides !== 20) return;
                if (this.state.phase === 'damage' && sides !== STATS.hero.dmgDie) return;

                this.animateDie(sides);

                setTimeout(() => {
                    if (this.state.phase === 'attack') this.resolvePlayerAttack();
                    else if (this.state.phase === 'damage') this.resolvePlayerDamage();
                }, 600);
            },

            resolvePlayerAttack() {
                const roll = Math.floor(Math.random() * 20) + 1;
                const total = roll + STATS.hero.ab;
                const isCrit = roll === 20;
                const isMiss = roll === 1 || total < STATS.enemy.ac;

                if (!isMiss) {
                    this.state.lastCrit = isCrit;
                    this.log(isCrit ? `CRITICAL HIT! (Natural 20)` : `HIT! Rolled ${roll} + ${STATS.hero.ab} = ${total}`, 'text-green-400');
                    this.state.phase = 'damage';
                    this.setTurnUI('player', 'damage'); 
                } else {
                    this.log(`MISSED! Rolled ${roll} + ${STATS.hero.ab} = ${total}`, 'text-red-400');
                    this.startEnemyTurn();
                }
            },

            resolvePlayerDamage() {
                let dmg = Math.floor(Math.random() * STATS.hero.dmgDie) + 1;
                if (this.state.lastCrit) dmg += Math.floor(Math.random() * STATS.hero.dmgDie) + 1; 
                dmg += STATS.hero.dmgMod;

                this.state.enemyHp = Math.max(0, this.state.enemyHp - dmg);
                this.triggerDamage('enemy');
                this.updateUI();
                this.log(`DEALT ${dmg} DAMAGE!`, 'text-white');

                if (this.state.enemyHp <= 0) setTimeout(() => this.endGame(true), 1000);
                else this.startEnemyTurn();
            },

            startEnemyTurn() {
                this.state.turn = 'enemy';
                this.setTurnUI('enemy', 'wait');
                this.log("The Ogre prepares to attack...", "text-red-500");
                
                setTimeout(() => { // Enemy Animation / Roll
                    this.animateDie(20); 
                    setTimeout(() => {
                        const roll = Math.floor(Math.random() * 20) + 1;
                        const total = roll + STATS.enemy.ab;
                        const isCrit = roll === 20;
                        const isHit = !((roll === 1) || (total < STATS.hero.ac));

                        if (isHit) {
                            this.log(`ENEMY HITS! Rolled ${roll}`, 'text-red-400');
                            setTimeout(() => {
                                this.animateDie(STATS.enemy.dmgDie);
                                setTimeout(() => {
                                    let dmg = Math.floor(Math.random() * STATS.enemy.dmgDie) + 1;
                                    if (isCrit) dmg += Math.floor(Math.random() * STATS.enemy.dmgDie) + 1;
                                    dmg += STATS.enemy.dmgMod;

                                    this.state.heroHp = Math.max(0, this.state.heroHp - dmg);
                                    this.triggerDamage('hero');
                                    this.updateUI();
                                    this.log(`TOOK ${dmg} DAMAGE!`, 'text-red-500');

                                    if (this.state.heroHp <= 0) setTimeout(() => this.endGame(false), 1000);
                                    else setTimeout(() => this.startPlayerTurn(), 2000);
                                }, 600);
                            }, 1000);
                        } else {
                            this.log(`ENEMY MISSED! Rolled ${roll}`, 'text-slate-400');
                            setTimeout(() => this.startPlayerTurn(), 2000);
                        }
                    }, 600);
                }, 1000);
            },

            startPlayerTurn() {
                this.state.turn = 'player';
                this.state.phase = 'attack';
                this.setTurnUI('player', 'attack');
                this.log("Roll D20 to attack!", "text-yellow-500");
            },

            // --- UI Updates ---
            setTurnUI(who, phase) {
                const banner = document.getElementById('turn-banner');
                if (who === 'player') {
                    banner.innerText = phase === 'attack' ? "Your Turn: Roll to Hit" : "Hit! Roll Damage";
                    banner.className = "inline-block mb-2 bg-yellow-600 text-black px-6 py-1 rounded-full font-bold uppercase tracking-widest text-xs shadow-lg animate-pulse";
                } else {
                    banner.innerText = "Enemy Turn";
                    banner.className = "inline-block mb-2 bg-red-900 text-white px-6 py-1 rounded-full font-bold uppercase tracking-widest text-xs shadow-lg";
                }

                document.getElementById('hero-panel').className = `split-panel border-r-4 border-slate-900 transition-all duration-500 ${who === 'player' ? 'active-turn' : 'inactive-turn'}`;
                document.getElementById('enemy-panel').className = `split-panel border-l-4 border-slate-900 transition-all duration-500 ${who === 'enemy' ? 'active-turn' : 'inactive-turn'}`;

                document.querySelectorAll('.die-btn').forEach(btn => btn.classList.remove('die-active'));
                
                if (who === 'player') {
                    if (phase === 'attack') document.getElementById('d20-btn').classList.add('die-active');
                    if (phase === 'damage') document.getElementById(`d${STATS.hero.dmgDie}-btn`).classList.add('die-active');
                }
            },

            updateUI() {
                document.getElementById('hero-hp-text').innerText = this.state.heroHp;
                document.getElementById('enemy-hp-text').innerText = this.state.enemyHp;
                document.getElementById('hero-bar').style.width = (this.state.heroHp / STATS.hero.max * 100) + '%';
                document.getElementById('enemy-bar').style.width = (this.state.enemyHp / STATS.enemy.max * 100) + '%';
            },

            animateDie(sides) {
                const el = document.getElementById(`d${sides}-btn`);
                if(el) {
                    el.classList.add('rolling'); 
                    // Visual flair: active state during enemy roll for visibility
                    el.style.opacity = '1';
                    el.style.filter = 'grayscale(0)';
                    
                    setTimeout(() => {
                        el.classList.remove('rolling');
                        if (this.state.turn !== 'player' && this.state.phase !== 'damage') {
                             el.style.opacity = '';
                             el.style.filter = '';
                        }
                    }, 500);
                }
            },

            triggerDamage(who) {
                const el = document.getElementById(`${who}-panel`);
                el.classList.add('taking-damage');
                setTimeout(() => el.classList.remove('taking-damage'), 300);
            },

            log(msg, color) {
                const el = document.getElementById('log-text');
                el.innerText = msg;
                el.className = `text-sm h-6 leading-6 truncate font-sans font-bold ${color}`;
            },

            endGame(win) {
                this.state.isOver = true;
                const el = document.getElementById('end-overlay');
                el.classList.remove('hidden');
                document.getElementById('end-title').innerText = win ? "VICTORY" : "DEFEAT";
                document.getElementById('end-title').className = win ? "text-6xl font-black text-yellow-500 mb-2 text-glow" : "text-6xl font-black text-red-600 mb-2 text-glow";
            }
        };

        window.onload = () => { lucide.createIcons(); battle.reset(); };
    </script>
</body>
</html>
